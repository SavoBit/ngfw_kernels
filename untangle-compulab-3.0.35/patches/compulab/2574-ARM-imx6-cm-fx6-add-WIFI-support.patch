From 84b9cc8f1f0a1a0306e9fb8f78de2316ca1c8abf Mon Sep 17 00:00:00 2001
From: Igor Grinberg <grinberg@compulab.co.il>
Date: Tue, 23 Apr 2013 16:50:58 +0300
Subject: ARM: imx6: cm-fx6: add WIFI support

Add support for Marvell 88W8787 WIFI chip.
---
 arch/arm/mach-mx6/board-cm-fx6-q.h |    4 ++++
 arch/arm/mach-mx6/board-cm-fx6.c   |   27 +++++++++++++++++++++++++++
 2 files changed, 31 insertions(+)

diff --git a/arch/arm/mach-mx6/board-cm-fx6-q.h b/arch/arm/mach-mx6/board-cm-fx6-q.h
index d2ac077..2e09ee4 100644
--- a/arch/arm/mach-mx6/board-cm-fx6-q.h
+++ b/arch/arm/mach-mx6/board-cm-fx6-q.h
@@ -152,6 +152,10 @@ static iomux_v3_cfg_t cm_fx6_q_common_pads[] = {
 
 	/* Audio codec: external clock */
 	MX6Q_PAD_GPIO_5__CCM_CLKO,
+
+	/* Wlan */
+	MX6Q_PAD_GPIO_17__GPIO_7_12,   /* WIFI NPD */
+	MX6Q_PAD_NANDF_CS3__GPIO_6_16, /* WIFI NRESET */
 };
 
 static iomux_v3_cfg_t cm_fx6_q_spdif_pads[] = {
diff --git a/arch/arm/mach-mx6/board-cm-fx6.c b/arch/arm/mach-mx6/board-cm-fx6.c
index c2a2ee4..596d840 100644
--- a/arch/arm/mach-mx6/board-cm-fx6.c
+++ b/arch/arm/mach-mx6/board-cm-fx6.c
@@ -87,6 +87,10 @@
 #define CM_FX6_ADS7846_PENDOWN		IMX_GPIO_NR(2, 15)
 #define CM_FX6_SATA_LDO_EN		IMX_GPIO_NR(2, 16)
 #define CM_FX6_ECSPI1_CS0		IMX_GPIO_NR(2, 30)
+
+#define CM_FX6_WIFI_NPD		IMX_GPIO_NR(7, 12)
+#define CM_FX6_WIFI_NRESET		IMX_GPIO_NR(6, 16)
+
 #define CM_FX6_GREEN_LED		IMX_GPIO_NR(2, 31)
 #define CM_FX6_ECSPI1_CS1		IMX_GPIO_NR(3, 19)
 #define CM_FX6_SATA_nSTANDBY1		IMX_GPIO_NR(3, 20)
@@ -1310,6 +1314,28 @@ static void __init cm_fx6_init_hdmi_audio(void)
 static inline void cm_fx6_init_hdmi_audio(void) {}
 #endif /* CONFIG_SND_SOC_IMX_HDMI */
 
+static struct gpio cm_fx6_wifi_gpios[] = {
+	{ CM_FX6_WIFI_NPD, GPIOF_OUT_INIT_HIGH, "wifi pdn" },
+	{ CM_FX6_WIFI_NRESET, GPIOF_OUT_INIT_LOW, "wifi rstn" },
+};
+
+static void cm_fx6_init_wifi(void)
+{
+	int err;
+
+	err = gpio_request_array(cm_fx6_wifi_gpios,
+							 ARRAY_SIZE(cm_fx6_wifi_gpios));
+	if (err) {
+		pr_err("CM-FX6: failed to request wifi-gpios: %d\n", err);
+	} else {
+		msleep(1);
+		gpio_set_value(CM_FX6_WIFI_NRESET, 1);
+	}
+
+	gpio_export(CM_FX6_WIFI_NPD, 0);
+	gpio_export(CM_FX6_WIFI_NRESET, 0);
+}
+
 static struct imx_asrc_platform_data imx_asrc_data = {
 	.channel_bits	= 4,
 	.clk_map_ver	= 2,
@@ -1396,6 +1422,7 @@ static void __init cm_fx6_init(void)
 
 	cm_fx6_i2c_init();
 	cm_fx6_init_led();
+	cm_fx6_init_wifi();
 	cm_fx6_spi_init();
 
 	imx6q_add_anatop_thermal_imx(1, &cm_fx6_anatop_thermal_data);
-- 
1.7.9.5

