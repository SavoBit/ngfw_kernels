From ba0737f4c83fd15b0e34492d3ff27d1d12226f10 Mon Sep 17 00:00:00 2001
From: Igor Grinberg <grinberg@compulab.co.il>
Date: Sun, 3 Mar 2013 09:51:46 +0200
Subject: ARM: i.MX6: cm-fx6: add support for HX8520 touch

Add support for HX8520_C dual-touch touchscreen.

Signed-off-by: Igor Grinberg <grinberg@compulab.co.il>
---
 arch/arm/mach-mx6/board-cm-fx6-dl.h |    2 ++
 arch/arm/mach-mx6/board-cm-fx6-q.h  |    2 ++
 arch/arm/mach-mx6/board-cm-fx6.c    |   26 ++++++++++++++++++++++++++
 3 files changed, 30 insertions(+)

diff --git a/arch/arm/mach-mx6/board-cm-fx6-dl.h b/arch/arm/mach-mx6/board-cm-fx6-dl.h
index 4790579..f28e1ad 100644
--- a/arch/arm/mach-mx6/board-cm-fx6-dl.h
+++ b/arch/arm/mach-mx6/board-cm-fx6-dl.h
@@ -26,6 +26,8 @@ static iomux_v3_cfg_t cm_fx6_dl_pads[] = {
 	MX6DL_PAD_EIM_EB3__GPIO_2_31,
 	/* ADS7846 PENDOWN */
 	MX6DL_PAD_SD4_DAT7__GPIO_2_15,
+	/* HX8520_C PENDOWN */
+	MX6DL_PAD_GPIO_4__GPIO_1_4,
 	/* USB HUB Reset */
 	MX6DL_PAD_SD3_RST__GPIO_7_8,
 	/* USBH1 VBUS control */
diff --git a/arch/arm/mach-mx6/board-cm-fx6-q.h b/arch/arm/mach-mx6/board-cm-fx6-q.h
index 1887222..aee2be7 100644
--- a/arch/arm/mach-mx6/board-cm-fx6-q.h
+++ b/arch/arm/mach-mx6/board-cm-fx6-q.h
@@ -26,6 +26,8 @@ static iomux_v3_cfg_t cm_fx6_q_common_pads[] = {
 	MX6Q_PAD_EIM_EB3__GPIO_2_31,
 	/* ADS7846 PENDOWN */
 	MX6Q_PAD_SD4_DAT7__GPIO_2_15,
+	/* HX8520_C PENDOWN */
+	MX6Q_PAD_GPIO_4__GPIO_1_4,
 	/* USB HUB Reset */
 	MX6Q_PAD_SD3_RST__GPIO_7_8,
 	/* USBH1 VBUS control */
diff --git a/arch/arm/mach-mx6/board-cm-fx6.c b/arch/arm/mach-mx6/board-cm-fx6.c
index d9d9fd4..6e8ac76 100644
--- a/arch/arm/mach-mx6/board-cm-fx6.c
+++ b/arch/arm/mach-mx6/board-cm-fx6.c
@@ -90,6 +90,7 @@
 #define CM_FX6_ECSPI2_CS3		IMX_GPIO_NR(3, 25)
 #define CM_FX6_USB_HUB_RST		IMX_GPIO_NR(7, 8)
 
+#define SB_FX6_HX8520_PENDOWN		IMX_GPIO_NR(1, 4)
 #define SB_FX6_SD3_WP			IMX_GPIO_NR(7, 0)
 #define SB_FX6_SD3_CD			IMX_GPIO_NR(7, 1)
 #define SB_FX6_GPIO_EXT_BASE		IMX_GPIO_NR(8, 0)
@@ -491,6 +492,23 @@ static struct pca953x_platform_data sb_fx6_gpio_ext_pdata = {
 };
 #endif
 
+#if defined(CONFIG_TOUCHSCREEN_HX8520_C) || \
+	defined(CONFIG_TOUCHSCREEN_HX8520_C_MODULE)
+static void __init hx8520_c_init(void)
+{
+	int err;
+
+	err = gpio_request_one(SB_FX6_HX8520_PENDOWN, GPIOF_IN, "hx8520_pen");
+	if (err) {
+		pr_err("Couldn't obtain gpio for hx8520_pen: %d\n", err);
+		return;
+	}
+	gpio_export(SB_FX6_HX8520_PENDOWN, 0);
+}
+#else /* CONFIG_TOUCHSCREEN_HX8520_C */
+static inline void hx8520_c_init(void) {}
+#endif /* CONFIG_TOUCHSCREEN_HX8520_C */
+
 #if defined(CONFIG_EEPROM_AT24) || defined(CONFIG_EEPROM_AT24_MODULE)
 static struct at24_platform_data sb_fx6_eeprom_pdata = {
         .byte_len       = 256,
@@ -505,6 +523,13 @@ static struct i2c_board_info cm_fx6_i2c0_board_info[] __initdata = {
 		.platform_data = &sb_fx6_gpio_ext_pdata,
 	},
 #endif
+#if defined(CONFIG_TOUCHSCREEN_HX8520_C) || \
+	defined(CONFIG_TOUCHSCREEN_HX8520_C_MODULE)
+	{
+		I2C_BOARD_INFO("hx8520-c", 0x4A),
+		.irq = gpio_to_irq(SB_FX6_HX8520_PENDOWN),
+	},
+#endif
 #if defined(CONFIG_EEPROM_AT24) || defined(CONFIG_EEPROM_AT24_MODULE)
 	{
 		I2C_BOARD_INFO("at24", 0x54),
@@ -556,6 +581,7 @@ static void __init i2c_register_bus_binfo(int busnum,
 
 static void __init cm_fx6_i2c_init(void)
 {
+	hx8520_c_init();
 	i2c_register_bus_binfo(0, &cm_fx6_i2c0_data, cm_fx6_i2c0_board_info,
 			       ARRAY_SIZE(cm_fx6_i2c0_board_info));
 	i2c_register_bus_binfo(1, &cm_fx6_i2c1_data, cm_fx6_i2c1_board_info,
-- 
1.7.9.5

